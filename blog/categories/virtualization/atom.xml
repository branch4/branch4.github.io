<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Virtualization | branch4 Blog]]></title>
  <link href="http://blog.branch4.pw/blog/categories/virtualization/atom.xml" rel="self"/>
  <link href="http://blog.branch4.pw/"/>
  <updated>2014-08-10T17:44:59+09:00</updated>
  <id>http://blog.branch4.pw/</id>
  <author>
    <name><![CDATA[root4]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Fluentdのテスト環境をvagrantでセットアップしてみるべ(複数サーバ管理)]]></title>
    <link href="http://blog.branch4.pw/blog/2014/08/08/setup-test-environment-with-vagrant2/"/>
    <updated>2014-08-08T22:00:00+09:00</updated>
    <id>http://blog.branch4.pw/blog/2014/08/08/setup-test-environment-with-vagrant2</id>
    <content type="html"><![CDATA[<p>こんにちは。前回の続きで、またVagrantのエントリ書いてる<a href="https://twitter.com/xengineer01">@xengineer01</a>です。</p>

<p><img src="http://blog.branch4.pw/images/2014/08/logo_vagrant.png" alt="vagrant logo" /></p>

<h2>前回のあらすじ</h2>

<p><a href="http://blog.branch4.pw/blog/2014/08/07/setup-test-environment-with-vagrant/">前回の記事</a>
は、下記あたりの流れをざっくり紹介しました。</p>

<ul>
<li>Vagrantってなんですか？</li>
<li>Vagrantのinstall</li>
<li>Vagrantfileの書き方</li>
<li>vagrantでソフトウェア関連設定</li>
<li>vagrantでサーバのハードウェアスペック指定</li>
</ul>


<p>前回は、サーバ１台の場合についてだったんで、今回は複数台管理する場合について。<br/>
この記事、本来の目的は、fluentdの検証をすることなんで、当然複数サーバあげたいわけで。</p>

<h2>概要</h2>

<hr />

<p>今回はたぶん、</p>

<p>1 Projectで複数サーバを管理する場合の、</p>

<ul>
<li>Vagrantfileの書き方</li>
<li>vagrant commandの使い方</li>
<li>networkについて</li>
<li>provisioningについて</li>
</ul>


<p>こんなところになる予定。</p>

<h2>各種バージョン</h2>

<hr />

<p>前回も書いたけど、このとおり。<br/>
今回は fluentdのバージョンも追記しておこう。</p>

<ul>
<li>vagrant version 1.6.3</li>
<li>Windows PC + VirtualBox 4.3.8r92456</li>
<li>MintLinux17 + VirtualBox 4.3 ?</li>
<li>MacOSX(Mavericks) + VirtualBox 4.3 ?</li>
</ul>


<h2>システム構成図</h2>

<hr />

<p>Appサーバのapacheのログを fluentd(HA) に投げて、postgres insertくらいを一旦の目処にしようかね。<br/>
最終的には、HTTP(RESTなのかは不明)で別apに投げるのと、S3でのバックアップ、くらいまでをやるか、
と思ってはいるけどどこまで書けるやら・・・。</p>

<p>一応構成図はこれ。</p>

<p><img src="https://blog.branch4.pw/images/2014/08/vagrant-multi-server01.png" alt="multi server01" /></p>

<!-- more -->


<h2>Vagrantfile複数サーバ対応</h2>

<hr />

<h3>１台のときは？</h3>

<p>何はなくとも予習と復習は大切です。<br/>
なので、前回の復習から。</p>

<p>```
$ cat Vagrantfile
VAGRANTFILE_API_VERSION = &ldquo;2&rdquo;</p>

<p>Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|
  config.vm.box = &ldquo;hashicorp/precise64&rdquo;
  config.vm.hostname = &ldquo;testserver&rdquo;
  config.vm.network &ldquo;public_network&rdquo;, bridge: &lsquo;en0: Wi-Fi (AirPort)&rsquo;
  config.vm.provision :shell, path: &ldquo;bootstrap.sh&rdquo;</p>

<p>  # ここから下を追記した
  config.vm.provider :virtualbox do |v|</p>

<pre><code>v.customize ["modifyvm", :id, "--memory", "512"]
v.customize ["modifyvm", :id, "--cpus", "1"]
v.customize ["modifyhd", "b5fc9c57-f008-4118-a03f-e535f25deea4", "--resize", "1024"]
</code></pre>

<p>  end
end
```</p>

<h3>Projectディレクトリと、Vagrantfile を作る！</h3>

<p>下記コマンドを実行してね。<br/>
(本Entryでは、以降Projectのルートディレクトリは、PROJECT_ROOTとします)
<code>``
$ mkdir &lt;PROJECT_ROOT&gt;
$ cd &lt;PROJECT_ROOT&gt;
$ vagrant init
A</code>Vagrantfile<code>has been placed in this directory. You are now
ready to</code>vagrant up<code>your first virtual environment! Please read
the comments in the Vagrantfile as well as documentation on
</code>vagrantup.com` for more information on using Vagrant.</p>

<p>```</p>

<p>やってることは、</p>

<ol>
<li>Projectディレクトリを作成</li>
<li>Projectディレクトリに移動</li>
<li>Projectを初期化(Vagrantfileが生成される)</li>
</ol>


<p>でございます。コマンドで生成された Vagrantfileから、コメントの行を消すと、、、</p>

<p>```
$ cat Vagrantfile</p>

<p>VAGRANTFILE_API_VERSION = &ldquo;2&rdquo;</p>

<p>Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|
  config.vm.box = &ldquo;base&rdquo;
end
```
こんな感じ。APIのバージョンは、"2" のようです。<br/>
config.vm.box = &ldquo;base"は、よくわからないけど、今はいいや。<br/>
Vagrantfile は、git,svn等の、VCSにcommitすべきものらしいので、commit。</p>

<h3>Box とは？</h3>

<p>生成された、Vagrantfile中にも出てくるけど、Boxとは？<br/>
Vagrant では、box っていうのが、ひとつのベースイメージになるんだと。<br/>
仮想イメージの呼び方をVagrant風に言うと &ldquo;Box&rdquo; なのです。</p>

<h3>Box のインストール</h3>

<p>まずは、自分のマシンに、Box(仮想イメージ)を追加します。<br/>
下記コマンドを、実行。</p>

<p>```
$ vagrant box add hashicorp/precise64
==> box: Loading metadata for box &lsquo;hashicorp/precise64&rsquo;</p>

<pre><code>box: URL: https://vagrantcloud.com/hashicorp/precise64
This box can work with multiple providers! The providers that it
can work with are listed below. Please review the list and choose
the provider you will be working with.

1) hyperv
2) virtualbox
3) vmware_fusion

Enter your choice: 2

==&gt; box: Adding box 'hashicorp/precise64' (v1.1.0) for provider: virtualbox
    box: Downloading: https://vagrantcloud.com/hashicorp/precise64/version/2/provider/virtualbox.box
    ==&gt; box: Successfully added box 'hashicorp/precise64' (v1.1.0) for 'virtualbox'!
</code></pre>

<p>```</p>

<p>今回使用してる、hashicorp さん謹製の box、precise64 は、</p>

<ul>
<li>hyperv</li>
<li>virtualbox</li>
<li>vmware_fusion</li>
</ul>


<p>に対応してるみたいだけど、2番の virtualbox を選択。<br/>
そうすると、下記ディレクトリ配下に、VirtualBox のイメージがダウンロードされたり、<br/>
Vagrantfileのような諸情報が格納されます。(結構時間かかる)</p>

<p>${HOME}/.vagrant.d<br/>
${HOME}/.vagrant.d/boxes<br/>
${HOME}/.vagrant.d/data<br/>
${HOME}/.vagrant.d/gems<br/>
${HOME}/.vagrant.d/rgloader<br/>
${HOME}/.vagrant.d/tmp</p>

<p>たぶん大事なのは、boxes 配下なのかな？きっとそうだろう。<br/>
イメージのダウンロード元は、<a href="https://vagrantcloud.com/">ここ</a>からみたい。</p>

<p>初期化完了した状態で、</p>

<p><code>
$ vagrant up
</code>
実行すると、今追加したほやほやのboxがすぐ起動。<br/>
ただ、諸々未設定なので、一旦落として設定しましょ。</p>

<ul>
<li>ネットワーク設定</li>
<li>ホスト名の設定</li>
<li>起動時にインストールするアプリがあるのかどうか</li>
</ul>


<p>などなど、設定していきます。<br/>
まずは、停止。</p>

<p><code>
$ vagrant destroy
</code></p>

<h3>Vagrantfile設定</h3>

<p>設定自体は、初期化時に生成された、Vagrantfileを編集していく。</p>

<p>Vagrantfile では、下記なんかを定義できる</p>

<ul>
<li>起動するマシンスペック</li>
<li>インストールするアプリケーション</li>
<li>どうやってアクセスするか</li>
</ul>


<p>今回は、こんなマシンにしようかな。</p>

<p><img src="http://blog.branch4.pw/images/2014/08/guestserver01.png" alt="guestserver" /></p>

<ul>
<li>CPU x 1 個</li>
<li>Memory 512 MB</li>
<li>HDD 15 GB</li>
<li>Ubuntu12.04</li>
<li>Network(DHCP/public)</li>
<li>hostname: testserver</li>
<li>apache pre-install</li>
</ul>


<p><a href="http://docs.vagrantup.com/v2/getting-started/index.html">ここ</a>とか、
<a href="http://docs.vagrantup.com/v2/virtualbox/configuration.html">ここ</a>を参照して、書いていく。<br/>
ハードのスペック関連は、VirtualBoxのAPI経由なので、<a href="http://www.virtualbox.org/manual/ch08.html">ここ</a>
からやりたいことを探すんだーね。<br/>
そして出来上がったVagrantfile。(まだスペック関連入れてない版)
```
$ cat Vagrantfile</p>

<p>VAGRANTFILE_API_VERSION = &ldquo;2&rdquo;</p>

<p>Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|
  config.vm.box = &ldquo;hashicorp/precise64&rdquo;
  config.vm.hostname = &ldquo;testserver&rdquo;
  config.vm.network &ldquo;public_network&rdquo;
  config.vm.provision :shell, path: &ldquo;bootstrap.sh&rdquo;
end
```
順番に説明。</p>

<h4>config.vm.box = &ldquo;hashicorp/precise64&rdquo;</h4>

<p>このBoxは、このイメージですよ！と、いうこと。</p>

<h4>config.vm.hostname = &ldquo;testserver&rdquo;</h4>

<p>Host名は、testserverですよ！と、いうこと。</p>

<h4>config.vm.network &ldquo;public_network&rdquo;</h4>

<p>Public、といっても、グローバルIPが必ず振られるわけではない。<br/>
たぶん、下記環境だったらグローバルが来るんじゃないか？</p>

<ul>
<li>Network IF が 1 つ</li>
<li>DHCP でグローバルが割り当てられる</li>
</ul>


<p>VirtualBox では、NAT になる。</p>

<p>Network IF が複数ある場合は、こんな感じに指定するそうな。
<code>
config.vm.network "public_network", bridge: 'en1: Wi-Fi(AirPort)'
</code></p>

<h4>config.vm.provision :shell, path: bootstrap.sh</h4>

<p>ゲストサーバ起動時に、PROJECT_ROOT/bootstrap.sh を実行しろ、ということ。<br/>
なので、ここに、</p>

<p>```</p>

<h1>!/usr/bin/evn bash</h1>

<p>apt-get update
apt-get install -y apache2
```</p>

<p>って書いておくと、起動時に、apache2 が入った状態になります。<br/>
さて、準備は整ったはずなので、いざ起動！！</p>

<p>```
$ vagrant up
Bringing machine &lsquo;default&rsquo; up with &lsquo;virtualbox&rsquo; provider&hellip;
==> default: Importing base box &lsquo;hashicorp/precise64&rsquo;&hellip;
==> default: Matching MAC address for NAT networking&hellip;
==> default: Checking if box &lsquo;hashicorp/precise64&rsquo; is up to date&hellip;
==> default: Setting the name of the VM: project_blog_default_1407340802923_76317
==> default: Fixed port collision for 22 => 2222. Now on port 2204.
==> default: Clearing any previously set network interfaces&hellip;
==> default: Available bridged network interfaces:
1) en0: Wi-Fi (AirPort)
2) en1: Thunderbolt 1
3) en2: Thunderbolt 2
4) bridge0
5) p2p0</p>

<p>```
あ、NIC だけじゃなくて色々あるから指定しないとだめなんですね・・・<br/>
一旦とめて、Vagrantfile を編集。</p>

<p>```
$ cat Vagrantfile</p>

<p>VAGRANTFILE_API_VERSION = &ldquo;2&rdquo;</p>

<p>Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|
  config.vm.box = &ldquo;hashicorp/precise64&rdquo;
  config.vm.hostname = &ldquo;testserver&rdquo;
  config.vm.network &ldquo;public_network&rdquo;
  config.vm.network &ldquo;public_network&rdquo;, bridge: &lsquo;en0: Wi-Fi (AirPort)&rsquo;
  config.vm.provision :shell, path: &ldquo;bootstrap.sh&rdquo;
end
```</p>

<p>気を取り直して、再度実行。</p>

<p>```
$ vagrant up
Bringing machine &lsquo;default&rsquo; up with &lsquo;virtualbox&rsquo; provider&hellip;
==> default: Checking if box &lsquo;hashicorp/precise64&rsquo; is up to date&hellip;
==> default: Fixed port collision for 22 => 2222. Now on port 2205.
==> default: Clearing any previously set network interfaces&hellip;
==> default: Preparing network interfaces based on configuration&hellip;</p>

<pre><code>default: Adapter 1: nat
default: Adapter 2: bridged
</code></pre>

<p>==> default: Forwarding ports&hellip;</p>

<pre><code>default: 22 =&gt; 2205 (adapter 1)
</code></pre>

<p>==> default: Booting VM&hellip;
==> default: Waiting for machine to boot. This may take a few minutes&hellip;</p>

<pre><code>default: SSH address: 127.0.0.1:2205
default: SSH username: vagrant
default: SSH auth method: private key
</code></pre>

<p>==> default: Machine booted and ready!
==> default: Checking for guest additions in VM&hellip;</p>

<pre><code>default: The guest additions on this VM do not match the installed version of
default: VirtualBox! In most cases this is fine, but in rare cases it can
default: prevent things such as shared folders from working properly. If you see
default: shared folder errors, please make sure the guest additions within the
default: virtual machine match the version of VirtualBox you have installed on
default: your host and reload your VM.
default:
default: Guest Additions Version: 4.2.0
default: VirtualBox Version: 4.3
</code></pre>

<p>==> default: Setting hostname&hellip;
==> default: Configuring and enabling network interfaces&hellip;
==> default: Mounting shared folders&hellip;</p>

<pre><code>default: /vagrant =&gt; /Users/nemoto_hideaki/work/vagrant/project_blog
</code></pre>

<p>==> default: Running provisioner: shell&hellip;</p>

<pre><code>default: Running: /var/folders/kn/k_t_9_cs0yjd5q44m9w8b8wh0000gn/T/vagrant-shell20140807-3962-19neoc2.sh
</code></pre>

<p>==> default: stdin: is not a tty
==> default: bash: /tmp/vagrant-shell: /usr/bin/evn: bad interpreter: No such file or directory
The following SSH command responded with a non-zero exit status.
Vagrant assumes that this means the command failed!</p>

<p>chmod +x /tmp/vagrant-shell &amp;&amp; /tmp/vagrant-shell</p>

<p>Stdout from the command:</p>

<p>Stderr from the command:</p>

<p>stdin: is not a tty
bash: /tmp/vagrant-shell: /usr/bin/evn: bad interpreter: No such file or directory
```</p>

<p>はい、再度失敗orz<br/>
なんだなんだ・・・bootstrap.shを確認確認・・・</p>

<p>&#35;!/usr/bin/evn bash<br/>
&#35;!/usr/bin/evn bash<br/>
&#35;!/usr/bin/evn bash<br/>
&#35;!/usr/bin/evn bash<br/>
&#35;!/usr/bin/evn bash</p>

<p>evn ね・・・修正いたしまして・・・
```
&#35;!/usr/bin/env bash</p>

<p>apt-get update
apt-get install -y apache2
```
修正して、再度実行。</p>

<p><code>
$ vagrant up
Bringing machine 'default' up with 'virtualbox' provider...
==&gt; default: Checking if box 'hashicorp/precise64' is up to date...
==&gt; default: VirtualBox VM is already running.
</code>
あ、さっき実行してるから実行中なのか。もしかして今回は bootstrap.sh が実行されてないかも。<br/>
なので、下記コマンドどっちかで強制実行。</p>

<p><code>
$ vagrant reload --provision
$ vagrant provision
</code></p>

<p>違いは、stdoutみる限り、たぶん・・・</p>

<h4>$ vagrant reload &mdash;provision</h4>

<p>こっちは一旦マシン再起動かけてからの強制実行。</p>

<h4>$ vagrant provision</h4>

<p>こっちは起動したままbootstrap.shだけ強制実行。</p>

<p>どっちか実行すると、ちゃんと apache がインストールされます。</p>

<h3>ログイン！</h3>

<p>次は実際にログインアクセスしますよと。
```
$ vagrant ssh
Welcome to Ubuntu 12.04 LTS (GNU/Linux 3.2.0-23-generic x86_64)</p>

<ul>
<li>Documentation:  <a href="https://help.ubuntu.com/">https://help.ubuntu.com/</a>
Welcome to your Vagrant-built virtual machine.
Last login: Fri Sep 14 06:23:18 2012 from 10.0.2.2
vagrant@testserver:~$
```</li>
</ul>


<p>おーいえす。ちゃんとホスト名も設定されてる。</p>

<p>ちなみに起動時の標準出力じっくりみると色々わかるんだけど、起動時に、guestのssh port(22)と、<br/>
hostの何番かを紐づけてくれてるので、そこにアクセスしてもいいのかも。<br/>
```
Hideaki-no-MacBook-Pro:project_blog nemoto_hideaki$ vagrant reload &mdash;provision
==> default: Attempting graceful shutdown of VM&hellip;
==> default: Checking if box &lsquo;hashicorp/precise64&rsquo; is up to date&hellip;
==> default: Clearing any previously set forwarded ports&hellip;
==> default: Fixed port collision for 22 => 2222. Now on port 2204.
==> default: Clearing any previously set network interfaces&hellip;
==> default: Preparing network interfaces based on configuration&hellip;</p>

<pre><code>default: Adapter 1: nat
default: Adapter 2: bridged
</code></pre>

<p>==> default: Forwarding ports&hellip;</p>

<pre><code>default: 22 =&gt; 2204 (adapter 1) &lt;--ここ！！★
</code></pre>

<p>==> default: Booting VM&hellip;
==> default: Waiting for machine to boot. This may take a few minutes&hellip;</p>

<pre><code>default: SSH address: 127.0.0.1:2204
default: SSH username: vagrant
default: SSH auth method: private key
</code></pre>

<p>==> default: Machine booted and ready!
==> default: Checking for guest additions in VM&hellip;
```</p>

<p>というわけで、localhostの 2204 番にアクセスしてみるも・・・
<code>
$ ssh -p 2204 vagrant@127.0.0.1
vagrant@127.0.0.1's password:
</code>
private key 設定すればよさげだけど・・・どの key だ？面倒なんでパス。<br/>
つまり、こんな設定をして、vagrant up/vagrant ssh すればつながるよ！<br/>
という話でした。</p>

<p>はっ！マシンスペック！変えるんだった。とりあえず、default のままのスペックは下記。<br/>
```
$ cat /proc/cpuinfo | grep -E &lsquo;processor|model name&rsquo;
processor: 0
model name: Intel&reg; Core&trade; i5-4258U CPU @ 2.40GHz
processor: 1
model name: Intel&reg; Core&trade; i5-4258U CPU @ 2.40GHz</p>

<p>$ free -m</p>

<pre><code>         total       used       free     shared    buffers     cached
         Mem:           365        321         43          0         11        248
         -/+ buffers/cache:         61        303
         Swap:          767          0        767
</code></pre>

<p>$ df -h
Filesystem                  Size  Used Avail Use% Mounted on
/dev/mapper/precise64-root   79G  2.3G   73G   4% /
udev                        174M  4.0K  174M   1% /dev
tmpfs                        74M  288K   73M   1% /run
none                        5.0M     0  5.0M   0% /run/lock
none                        183M     0  183M   0% /run/shm
/dev/sda1                   228M   25M  192M  12% /boot
vagrant                     233G   92G  142G  40% /vagrant
```
CPU : 2個
Memory : 384MB
HDD : 80GB
(VirtualBox の GUI から引っ張って来てるスペック)</p>

<ul>
<li>CPU : 1個</li>
<li>Memory 512MB</li>
<li>HDD 15GB</li>
</ul>


<p>やることは、</p>

<ul>
<li>CPUを一個に減らす</li>
<li>Memoryを512MBに増やす</li>
<li>HDDを15GBに減らす</li>
</ul>


<p><a href="http://docs.vagrantup.com/v2/virtualbox/configuration.html">参考サイト１</a><br/>
<a href="http://www.virtualbox.org/manual/ch08.html">参考サイト２</a><br/>
上記２サイトを見比べた結果・・・
```
$ cat Vagrantfile
VAGRANTFILE_API_VERSION = &ldquo;2&rdquo;</p>

<p>Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|
  config.vm.box = &ldquo;hashicorp/precise64&rdquo;
  config.vm.hostname = &ldquo;testserver&rdquo;
  config.vm.network &ldquo;public_network&rdquo;, bridge: &lsquo;en0: Wi-Fi (AirPort)&rsquo;
  config.vm.provision :shell, path: &ldquo;bootstrap.sh&rdquo;</p>

<p>  # ここから下を追記した
  config.vm.provider :virtualbox do |v|</p>

<pre><code>v.customize ["modifyvm", :id, "--memory", "512"]
v.customize ["modifyvm", :id, "--cpus", "1"]
v.customize ["modifyhd", "b5fc9c57-f008-4118-a03f-e535f25deea4", "--resize", "1024"]
</code></pre>

<p>  end
end
<code>
こう。こんな感じでいけるはず。  
modifyhd の横の、"b5fc9c57-f008-4118-a03f-e535f25deea4"は、VirtualBox イメージのイメージファイルの UUID。  
下記コマンド実行すればみれるです。
</code>
$ VBoxManage list -l vms
Name:            project_blog_default_1407343357247_93821
Groups:          /
Guest OS:        Ubuntu (64 bit)
UUID:            7819729d-541f-47b8-8607-ec50965f4901
&hellip;
(中略)
&hellip;
SATA Controller (0, 0): /Users/nemoto_hideaki/VirtualBox VMs/project_blog_default_1407343357247_93821/box-disk1.vmdk (UUID: b5fc9c57-f008-4118-a03f-e535f25deea4) &lt;&mdash; これ！！
&hellip;
(中略)
&hellip;
```</p>

<p>よし！実行！
```
$ vagrant up
Bringing machine &lsquo;default&rsquo; up with &lsquo;virtualbox&rsquo; provider&hellip;
&hellip;
(中略)
&hellip;
A customization command failed:</p>

<p>[&ldquo;modifyhd&rdquo;, &ldquo;b5fc9c57-f008-4118-a03f-e535f25deea4&rdquo;, &ldquo;&mdash;resize&rdquo;, &ldquo;1024&rdquo;]</p>

<p>The following error was experienced:</p>

<h1>&lt;Vagrant::Errors::VBoxManageError: There was an error while executing <code>VBoxManage</code>, a CLI used by Vagrant</h1>

<p>for controlling VirtualBox. The command and stderr is shown below.</p>

<p>Command: [&ldquo;modifyhd&rdquo;, &ldquo;b5fc9c57-f008-4118-a03f-e535f25deea4&rdquo;, &ldquo;&mdash;resize&rdquo;, &ldquo;1024&rdquo;]</p>

<p>Stderr: 0%&hellip;
Progress state: VBOX_E_NOT_SUPPORTED
VBoxManage: error: Resize hard disk operation for this format is not implemented yet!</p>

<blockquote></blockquote>

<p>Please fix this customization and try again.
```</p>

<p>はい、まただめ・・・orz<br/>
VBoxManage: error: Resize hard disk operation for this format is not implemented yet!<br/>
まだ実装してねーってよ。あきらめよう。</p>

<p>HDD の件を削って実行して、スペック確認した結果。
```
vagrant@testserver:~$ cat /proc/cpuinfo | grep -E &lsquo;processor|model name&rsquo;
processor   : 0
model name  : Intel&reg; Core&trade; i5-4258U CPU @ 2.40GHz
vagrant@testserver:~$ free -m</p>

<pre><code>         total       used       free     shared    buffers     cached
</code></pre>

<p>Mem:           491        338        153          0         15        260
&ndash;/+ buffers/cache:         61        429
Swap:          767          0        767
vagrant@testserver:~$ df -h
Filesystem                  Size  Used Avail Use% Mounted on
/dev/mapper/precise64-root   79G  2.3G   73G   4% /
udev                        237M  4.0K  237M   1% /dev
tmpfs                        99M  288K   99M   1% /run
none                        5.0M     0  5.0M   0% /run/lock
none                        246M     0  246M   0% /run/shm
/dev/sda1                   228M   25M  192M  12% /boot
vagrant                     233G   92G  142G  40% /vagrant
```</p>

<p>HDD リサイズとかは、たぶん Box 定義からいじる、とかなのかな？<br/>
その辺の深追いはまた今度。<br/>
まず今日の課題はクリアで。</p>

<p><img src="http://blog.branch4.pw/images/2014/08/guestserver01_nohdd.png" alt="guestserver_hddstay" /></p>

<h2>次回予告</h2>

<p>複数サーバをぼこぼこあげるとき。</p>

<script type="text/javascript" language="javascript">
  num = Math.floor( Math.random() * 6 );
  document.write( aff[ num ]);
</script>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Fluentdのテスト環境をvagrantでセットアップしてみるべ]]></title>
    <link href="http://blog.branch4.pw/blog/2014/08/07/setup-test-environment-with-vagrant/"/>
    <updated>2014-08-07T22:00:00+09:00</updated>
    <id>http://blog.branch4.pw/blog/2014/08/07/setup-test-environment-with-vagrant</id>
    <content type="html"><![CDATA[<p>こんにちは。Vagrant使ってみよ。と思った<a href="https://twitter.com/xengineer01">@xengineer01</a>です。</p>

<p><img src="http://blog.branch4.pw/images/2014/08/logo_vagrant.png" alt="vagrant logo" /></p>

<h2>概要</h2>

<hr />

<p>まぁ使ってみたかっただけです。<br/>
fluentdの検証するし、今後も環境構築は何回もするし、ついでだから vagrant使ってみよ、<br/>
なノリです。</p>

<p>実際は、今回のエントリーでは fluentd の環境構築までいかなかったので、何回かに分けて書きますわ。</p>

<h2>vagrantって？</h2>

<hr />

<p>どこでも同じ環境を寸分違わず再現できるセットアップツール、って感じなのかな。<br/>
boxつくって、設定ファイル書いとけば、どこに持ってっても同じ環境が作れて、<br/>
問題の再現とかもしやすい、ということです。便利だわー。<br/>
今回は、数年ぶりに環境構築する用事があったので、使おうと思ったり。</p>

<!-- more -->


<h2>インストール</h2>

<hr />

<p><a href="http://www.vagrantup.com/downloads">こちら</a>からダウンロードしてインストール。<br/>
簡単だから。ただし、ツール自体にGUIはないのでCLIに抵抗がある人はここでおかえりいただきます。</p>

<h2>セットアップ</h2>

<hr />

<p>まずは、<a href="http://www.vagrantup.com/">公式サイト</a>のドキュメンツを辿ってみるべし。<br/>
Getting Startedを一通りやれば結構わかる。</p>

<h2>諸情報</h2>

<p>今回使ったのは、</p>

<ul>
<li>vagrant version 1.6.3</li>
<li>Windows PC + VirtualBox 4.3.8r92456</li>
<li>MintLinux17 + VirtualBox 4.3 ?</li>
<li>MacOSX(Mavericks) + VirtualBox 4.3 ?</li>
</ul>


<p>でございます。作った Vagrantfile 含めた設定は、全環境でちゃんと動いてるぽかったです。</p>

<h3>Vagrantfile なる設定ファイルが肝</h3>

<p>設定ファイルのこと。</p>

<ul>
<li>1つのプロジェクトあたり、1つ存在する。</li>
<li>プロジェクト内に、どんなサーバが何台存在しているか</li>
<li>ネットワーク構成どんな感じか</li>
<li>各サーバに何インストールしとくか、設定どうなってるか</li>
</ul>


<p>などなど定義します。たぶん、流れ的には、</p>

<ul>
<li>Vagrantfileの書き方覚える</li>
<li>Provisioningツールの使い方覚える or 既に覚えてれば不要</li>
<li>Provider(VirtualBox/KVM/Docker etc&hellip;)の使い分け的なものを覚える</li>
<li>Boxの作り方覚える</li>
</ul>


<p>この辺を覚えていくんでしょう。</p>

<h3>Projectディレクトリと、Vagrantfile を作る！</h3>

<p>下記コマンドを実行してね。<br/>
(本Entryでは、以降Projectのルートディレクトリは、PROJECT_ROOTとします)
<code>``
$ mkdir &lt;PROJECT_ROOT&gt;
$ cd &lt;PROJECT_ROOT&gt;
$ vagrant init
A</code>Vagrantfile<code>has been placed in this directory. You are now
ready to</code>vagrant up<code>your first virtual environment! Please read
the comments in the Vagrantfile as well as documentation on
</code>vagrantup.com` for more information on using Vagrant.</p>

<p>```</p>

<p>やってることは、</p>

<ol>
<li>Projectディレクトリを作成</li>
<li>Projectディレクトリに移動</li>
<li>Projectを初期化(Vagrantfileが生成される)</li>
</ol>


<p>でございます。コマンドで生成された Vagrantfileから、コメントの行を消すと、、、</p>

<p>```
$ cat Vagrantfile</p>

<p>VAGRANTFILE_API_VERSION = &ldquo;2&rdquo;</p>

<p>Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|
  config.vm.box = &ldquo;base&rdquo;
end
```
こんな感じ。APIのバージョンは、"2" のようです。<br/>
config.vm.box = &ldquo;base"は、よくわからないけど、今はいいや。<br/>
Vagrantfile は、git,svn等の、VCSにcommitすべきものらしいので、commit。</p>

<h3>Box とは？</h3>

<p>生成された、Vagrantfile中にも出てくるけど、Boxとは？<br/>
Vagrant では、box っていうのが、ひとつのベースイメージになるんだと。<br/>
仮想イメージの呼び方をVagrant風に言うと &ldquo;Box&rdquo; なのです。</p>

<h3>Box のインストール</h3>

<p>まずは、自分のマシンに、Box(仮想イメージ)を追加します。<br/>
下記コマンドを、実行。</p>

<p>```
$ vagrant box add hashicorp/precise64
==> box: Loading metadata for box &lsquo;hashicorp/precise64&rsquo;</p>

<pre><code>box: URL: https://vagrantcloud.com/hashicorp/precise64
This box can work with multiple providers! The providers that it
can work with are listed below. Please review the list and choose
the provider you will be working with.

1) hyperv
2) virtualbox
3) vmware_fusion

Enter your choice: 2

==&gt; box: Adding box 'hashicorp/precise64' (v1.1.0) for provider: virtualbox
    box: Downloading: https://vagrantcloud.com/hashicorp/precise64/version/2/provider/virtualbox.box
    ==&gt; box: Successfully added box 'hashicorp/precise64' (v1.1.0) for 'virtualbox'!
</code></pre>

<p>```</p>

<p>今回使用してる、hashicorp さん謹製の box、precise64 は、</p>

<ul>
<li>hyperv</li>
<li>virtualbox</li>
<li>vmware_fusion</li>
</ul>


<p>に対応してるみたいだけど、2番の virtualbox を選択。<br/>
そうすると、下記ディレクトリ配下に、VirtualBox のイメージがダウンロードされたり、<br/>
Vagrantfileのような諸情報が格納されます。(結構時間かかる)</p>

<p>${HOME}/.vagrant.d<br/>
${HOME}/.vagrant.d/boxes<br/>
${HOME}/.vagrant.d/data<br/>
${HOME}/.vagrant.d/gems<br/>
${HOME}/.vagrant.d/rgloader<br/>
${HOME}/.vagrant.d/tmp</p>

<p>たぶん大事なのは、boxes 配下なのかな？きっとそうだろう。<br/>
イメージのダウンロード元は、<a href="https://vagrantcloud.com/">ここ</a>からみたい。</p>

<p>初期化完了した状態で、</p>

<p><code>
$ vagrant up
</code>
実行すると、今追加したほやほやのboxがすぐ起動。<br/>
ただ、諸々未設定なので、一旦落として設定しましょ。</p>

<ul>
<li>ネットワーク設定</li>
<li>ホスト名の設定</li>
<li>起動時にインストールするアプリがあるのかどうか</li>
</ul>


<p>などなど、設定していきます。<br/>
まずは、停止。</p>

<p><code>
$ vagrant destroy
</code></p>

<h3>Vagrantfile設定</h3>

<p>設定自体は、初期化時に生成された、Vagrantfileを編集していく。</p>

<p>Vagrantfile では、下記なんかを定義できる</p>

<ul>
<li>起動するマシンスペック</li>
<li>インストールするアプリケーション</li>
<li>どうやってアクセスするか</li>
</ul>


<p>今回は、こんなマシンにしようかな。</p>

<p><img src="http://blog.branch4.pw/images/2014/08/guestserver01.png" alt="guestserver" /></p>

<ul>
<li>CPU x 1 個</li>
<li>Memory 512 MB</li>
<li>HDD 15 GB</li>
<li>Ubuntu12.04</li>
<li>Network(DHCP/public)</li>
<li>hostname: testserver</li>
<li>apache pre-install</li>
</ul>


<p><a href="http://docs.vagrantup.com/v2/getting-started/index.html">ここ</a>とか、
<a href="http://docs.vagrantup.com/v2/virtualbox/configuration.html">ここ</a>を参照して、書いていく。<br/>
ハードのスペック関連は、VirtualBoxのAPI経由なので、<a href="http://www.virtualbox.org/manual/ch08.html">ここ</a>
からやりたいことを探すんだーね。<br/>
そして出来上がったVagrantfile。(まだスペック関連入れてない版)
```
$ cat Vagrantfile</p>

<p>VAGRANTFILE_API_VERSION = &ldquo;2&rdquo;</p>

<p>Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|
  config.vm.box = &ldquo;hashicorp/precise64&rdquo;
  config.vm.hostname = &ldquo;testserver&rdquo;
  config.vm.network &ldquo;public_network&rdquo;
  config.vm.provision :shell, path: &ldquo;bootstrap.sh&rdquo;
end
```
順番に説明。</p>

<h4>config.vm.box = &ldquo;hashicorp/precise64&rdquo;</h4>

<p>このBoxは、このイメージですよ！と、いうこと。</p>

<h4>config.vm.hostname = &ldquo;testserver&rdquo;</h4>

<p>Host名は、testserverですよ！と、いうこと。</p>

<h4>config.vm.network &ldquo;public_network&rdquo;</h4>

<p>Public、といっても、グローバルIPが必ず振られるわけではない。<br/>
たぶん、下記環境だったらグローバルが来るんじゃないか？</p>

<ul>
<li>Network IF が 1 つ</li>
<li>DHCP でグローバルが割り当てられる</li>
</ul>


<p>VirtualBox では、NAT になる。</p>

<p>Network IF が複数ある場合は、こんな感じに指定するそうな。
<code>
config.vm.network "public_network", bridge: 'en1: Wi-Fi(AirPort)'
</code></p>

<h4>config.vm.provision :shell, path: bootstrap.sh</h4>

<p>ゲストサーバ起動時に、PROJECT_ROOT/bootstrap.sh を実行しろ、ということ。<br/>
なので、ここに、</p>

<p>```</p>

<h1>!/usr/bin/evn bash</h1>

<p>apt-get update
apt-get install -y apache2
```</p>

<p>って書いておくと、起動時に、apache2 が入った状態になります。<br/>
さて、準備は整ったはずなので、いざ起動！！</p>

<p>```
$ vagrant up
Bringing machine &lsquo;default&rsquo; up with &lsquo;virtualbox&rsquo; provider&hellip;
==> default: Importing base box &lsquo;hashicorp/precise64&rsquo;&hellip;
==> default: Matching MAC address for NAT networking&hellip;
==> default: Checking if box &lsquo;hashicorp/precise64&rsquo; is up to date&hellip;
==> default: Setting the name of the VM: project_blog_default_1407340802923_76317
==> default: Fixed port collision for 22 => 2222. Now on port 2204.
==> default: Clearing any previously set network interfaces&hellip;
==> default: Available bridged network interfaces:
1) en0: Wi-Fi (AirPort)
2) en1: Thunderbolt 1
3) en2: Thunderbolt 2
4) bridge0
5) p2p0</p>

<p>```
あ、NIC だけじゃなくて色々あるから指定しないとだめなんですね・・・<br/>
一旦とめて、Vagrantfile を編集。</p>

<p>```
$ cat Vagrantfile</p>

<p>VAGRANTFILE_API_VERSION = &ldquo;2&rdquo;</p>

<p>Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|
  config.vm.box = &ldquo;hashicorp/precise64&rdquo;
  config.vm.hostname = &ldquo;testserver&rdquo;
  config.vm.network &ldquo;public_network&rdquo;
  config.vm.network &ldquo;public_network&rdquo;, bridge: &lsquo;en0: Wi-Fi (AirPort)&rsquo;
  config.vm.provision :shell, path: &ldquo;bootstrap.sh&rdquo;
end
```</p>

<p>気を取り直して、再度実行。</p>

<p>```
$ vagrant up
Bringing machine &lsquo;default&rsquo; up with &lsquo;virtualbox&rsquo; provider&hellip;
==> default: Checking if box &lsquo;hashicorp/precise64&rsquo; is up to date&hellip;
==> default: Fixed port collision for 22 => 2222. Now on port 2205.
==> default: Clearing any previously set network interfaces&hellip;
==> default: Preparing network interfaces based on configuration&hellip;</p>

<pre><code>default: Adapter 1: nat
default: Adapter 2: bridged
</code></pre>

<p>==> default: Forwarding ports&hellip;</p>

<pre><code>default: 22 =&gt; 2205 (adapter 1)
</code></pre>

<p>==> default: Booting VM&hellip;
==> default: Waiting for machine to boot. This may take a few minutes&hellip;</p>

<pre><code>default: SSH address: 127.0.0.1:2205
default: SSH username: vagrant
default: SSH auth method: private key
</code></pre>

<p>==> default: Machine booted and ready!
==> default: Checking for guest additions in VM&hellip;</p>

<pre><code>default: The guest additions on this VM do not match the installed version of
default: VirtualBox! In most cases this is fine, but in rare cases it can
default: prevent things such as shared folders from working properly. If you see
default: shared folder errors, please make sure the guest additions within the
default: virtual machine match the version of VirtualBox you have installed on
default: your host and reload your VM.
default:
default: Guest Additions Version: 4.2.0
default: VirtualBox Version: 4.3
</code></pre>

<p>==> default: Setting hostname&hellip;
==> default: Configuring and enabling network interfaces&hellip;
==> default: Mounting shared folders&hellip;</p>

<pre><code>default: /vagrant =&gt; /Users/nemoto_hideaki/work/vagrant/project_blog
</code></pre>

<p>==> default: Running provisioner: shell&hellip;</p>

<pre><code>default: Running: /var/folders/kn/k_t_9_cs0yjd5q44m9w8b8wh0000gn/T/vagrant-shell20140807-3962-19neoc2.sh
</code></pre>

<p>==> default: stdin: is not a tty
==> default: bash: /tmp/vagrant-shell: /usr/bin/evn: bad interpreter: No such file or directory
The following SSH command responded with a non-zero exit status.
Vagrant assumes that this means the command failed!</p>

<p>chmod +x /tmp/vagrant-shell &amp;&amp; /tmp/vagrant-shell</p>

<p>Stdout from the command:</p>

<p>Stderr from the command:</p>

<p>stdin: is not a tty
bash: /tmp/vagrant-shell: /usr/bin/evn: bad interpreter: No such file or directory
```</p>

<p>はい、再度失敗orz<br/>
なんだなんだ・・・bootstrap.shを確認確認・・・</p>

<p>&#35;!/usr/bin/evn bash<br/>
&#35;!/usr/bin/evn bash<br/>
&#35;!/usr/bin/evn bash<br/>
&#35;!/usr/bin/evn bash<br/>
&#35;!/usr/bin/evn bash</p>

<p>evn ね・・・修正いたしまして・・・
```
&#35;!/usr/bin/env bash</p>

<p>apt-get update
apt-get install -y apache2
```
修正して、再度実行。</p>

<p><code>
$ vagrant up
Bringing machine 'default' up with 'virtualbox' provider...
==&gt; default: Checking if box 'hashicorp/precise64' is up to date...
==&gt; default: VirtualBox VM is already running.
</code>
あ、さっき実行してるから実行中なのか。もしかして今回は bootstrap.sh が実行されてないかも。<br/>
なので、下記コマンドどっちかで強制実行。</p>

<p><code>
$ vagrant reload --provision
$ vagrant provision
</code></p>

<p>違いは、stdoutみる限り、たぶん・・・</p>

<h4>$ vagrant reload &mdash;provision</h4>

<p>こっちは一旦マシン再起動かけてからの強制実行。</p>

<h4>$ vagrant provision</h4>

<p>こっちは起動したままbootstrap.shだけ強制実行。</p>

<p>どっちか実行すると、ちゃんと apache がインストールされます。</p>

<h3>ログイン！</h3>

<p>次は実際にログインアクセスしますよと。
```
$ vagrant ssh
Welcome to Ubuntu 12.04 LTS (GNU/Linux 3.2.0-23-generic x86_64)</p>

<ul>
<li>Documentation:  <a href="https://help.ubuntu.com/">https://help.ubuntu.com/</a>
Welcome to your Vagrant-built virtual machine.
Last login: Fri Sep 14 06:23:18 2012 from 10.0.2.2
vagrant@testserver:~$
```</li>
</ul>


<p>おーいえす。ちゃんとホスト名も設定されてる。</p>

<p>ちなみに起動時の標準出力じっくりみると色々わかるんだけど、起動時に、guestのssh port(22)と、<br/>
hostの何番かを紐づけてくれてるので、そこにアクセスしてもいいのかも。<br/>
```
Hideaki-no-MacBook-Pro:project_blog nemoto_hideaki$ vagrant reload &mdash;provision
==> default: Attempting graceful shutdown of VM&hellip;
==> default: Checking if box &lsquo;hashicorp/precise64&rsquo; is up to date&hellip;
==> default: Clearing any previously set forwarded ports&hellip;
==> default: Fixed port collision for 22 => 2222. Now on port 2204.
==> default: Clearing any previously set network interfaces&hellip;
==> default: Preparing network interfaces based on configuration&hellip;</p>

<pre><code>default: Adapter 1: nat
default: Adapter 2: bridged
</code></pre>

<p>==> default: Forwarding ports&hellip;</p>

<pre><code>default: 22 =&gt; 2204 (adapter 1) &lt;--ここ！！★
</code></pre>

<p>==> default: Booting VM&hellip;
==> default: Waiting for machine to boot. This may take a few minutes&hellip;</p>

<pre><code>default: SSH address: 127.0.0.1:2204
default: SSH username: vagrant
default: SSH auth method: private key
</code></pre>

<p>==> default: Machine booted and ready!
==> default: Checking for guest additions in VM&hellip;
```</p>

<p>というわけで、localhostの 2204 番にアクセスしてみるも・・・
<code>
$ ssh -p 2204 vagrant@127.0.0.1
vagrant@127.0.0.1's password:
</code>
private key 設定すればよさげだけど・・・どの key だ？面倒なんでパス。<br/>
つまり、こんな設定をして、vagrant up/vagrant ssh すればつながるよ！<br/>
という話でした。</p>

<p>はっ！マシンスペック！変えるんだった。とりあえず、default のままのスペックは下記。<br/>
```
$ cat /proc/cpuinfo | grep -E &lsquo;processor|model name&rsquo;
processor: 0
model name: Intel&reg; Core&trade; i5-4258U CPU @ 2.40GHz
processor: 1
model name: Intel&reg; Core&trade; i5-4258U CPU @ 2.40GHz</p>

<p>$ free -m</p>

<pre><code>         total       used       free     shared    buffers     cached
         Mem:           365        321         43          0         11        248
         -/+ buffers/cache:         61        303
         Swap:          767          0        767
</code></pre>

<p>$ df -h
Filesystem                  Size  Used Avail Use% Mounted on
/dev/mapper/precise64-root   79G  2.3G   73G   4% /
udev                        174M  4.0K  174M   1% /dev
tmpfs                        74M  288K   73M   1% /run
none                        5.0M     0  5.0M   0% /run/lock
none                        183M     0  183M   0% /run/shm
/dev/sda1                   228M   25M  192M  12% /boot
vagrant                     233G   92G  142G  40% /vagrant
```
CPU : 2個
Memory : 384MB
HDD : 80GB
(VirtualBox の GUI から引っ張って来てるスペック)</p>

<ul>
<li>CPU : 1個</li>
<li>Memory 512MB</li>
<li>HDD 15GB</li>
</ul>


<p>やることは、</p>

<ul>
<li>CPUを一個に減らす</li>
<li>Memoryを512MBに増やす</li>
<li>HDDを15GBに減らす</li>
</ul>


<p><a href="http://docs.vagrantup.com/v2/virtualbox/configuration.html">参考サイト１</a><br/>
<a href="http://www.virtualbox.org/manual/ch08.html">参考サイト２</a><br/>
上記２サイトを見比べた結果・・・
```
$ cat Vagrantfile
VAGRANTFILE_API_VERSION = &ldquo;2&rdquo;</p>

<p>Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|
  config.vm.box = &ldquo;hashicorp/precise64&rdquo;
  config.vm.hostname = &ldquo;testserver&rdquo;
  config.vm.network &ldquo;public_network&rdquo;, bridge: &lsquo;en0: Wi-Fi (AirPort)&rsquo;
  config.vm.provision :shell, path: &ldquo;bootstrap.sh&rdquo;</p>

<p>  # ここから下を追記した
  config.vm.provider :virtualbox do |v|</p>

<pre><code>v.customize ["modifyvm", :id, "--memory", "512"]
v.customize ["modifyvm", :id, "--cpus", "1"]
v.customize ["modifyhd", "b5fc9c57-f008-4118-a03f-e535f25deea4", "--resize", "1024"]
</code></pre>

<p>  end
end
<code>
こう。こんな感じでいけるはず。  
modifyhd の横の、"b5fc9c57-f008-4118-a03f-e535f25deea4"は、VirtualBox イメージのイメージファイルの UUID。  
下記コマンド実行すればみれるです。
</code>
$ VBoxManage list -l vms
Name:            project_blog_default_1407343357247_93821
Groups:          /
Guest OS:        Ubuntu (64 bit)
UUID:            7819729d-541f-47b8-8607-ec50965f4901
&hellip;
(中略)
&hellip;
SATA Controller (0, 0): /Users/nemoto_hideaki/VirtualBox VMs/project_blog_default_1407343357247_93821/box-disk1.vmdk (UUID: b5fc9c57-f008-4118-a03f-e535f25deea4) &lt;&mdash; これ！！
&hellip;
(中略)
&hellip;
```</p>

<p>よし！実行！
```
$ vagrant up
Bringing machine &lsquo;default&rsquo; up with &lsquo;virtualbox&rsquo; provider&hellip;
&hellip;
(中略)
&hellip;
A customization command failed:</p>

<p>[&ldquo;modifyhd&rdquo;, &ldquo;b5fc9c57-f008-4118-a03f-e535f25deea4&rdquo;, &ldquo;&mdash;resize&rdquo;, &ldquo;1024&rdquo;]</p>

<p>The following error was experienced:</p>

<h1>&lt;Vagrant::Errors::VBoxManageError: There was an error while executing <code>VBoxManage</code>, a CLI used by Vagrant</h1>

<p>for controlling VirtualBox. The command and stderr is shown below.</p>

<p>Command: [&ldquo;modifyhd&rdquo;, &ldquo;b5fc9c57-f008-4118-a03f-e535f25deea4&rdquo;, &ldquo;&mdash;resize&rdquo;, &ldquo;1024&rdquo;]</p>

<p>Stderr: 0%&hellip;
Progress state: VBOX_E_NOT_SUPPORTED
VBoxManage: error: Resize hard disk operation for this format is not implemented yet!</p>

<blockquote></blockquote>

<p>Please fix this customization and try again.
```</p>

<p>はい、まただめ・・・orz<br/>
VBoxManage: error: Resize hard disk operation for this format is not implemented yet!<br/>
まだ実装してねーってよ。あきらめよう。</p>

<p>HDD の件を削って実行して、スペック確認した結果。
```
vagrant@testserver:~$ cat /proc/cpuinfo | grep -E &lsquo;processor|model name&rsquo;
processor   : 0
model name  : Intel&reg; Core&trade; i5-4258U CPU @ 2.40GHz
vagrant@testserver:~$ free -m</p>

<pre><code>         total       used       free     shared    buffers     cached
</code></pre>

<p>Mem:           491        338        153          0         15        260
&ndash;/+ buffers/cache:         61        429
Swap:          767          0        767
vagrant@testserver:~$ df -h
Filesystem                  Size  Used Avail Use% Mounted on
/dev/mapper/precise64-root   79G  2.3G   73G   4% /
udev                        237M  4.0K  237M   1% /dev
tmpfs                        99M  288K   99M   1% /run
none                        5.0M     0  5.0M   0% /run/lock
none                        246M     0  246M   0% /run/shm
/dev/sda1                   228M   25M  192M  12% /boot
vagrant                     233G   92G  142G  40% /vagrant
```</p>

<p>HDD リサイズとかは、たぶん Box 定義からいじる、とかなのかな？<br/>
その辺の深追いはまた今度。<br/>
まず今日の課題はクリアで。</p>

<p><img src="http://blog.branch4.pw/images/2014/08/guestserver01_nohdd.png" alt="guestserver_hddstay" /></p>

<h2>次回予告</h2>

<p>複数サーバをぼこぼこあげるとき。</p>

<script type="text/javascript" language="javascript">
  num = Math.floor( Math.random() * 6 );
  document.write( aff[ num ]);
</script>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Memo on Libvirt API]]></title>
    <link href="http://blog.branch4.pw/blog/2012/04/01/memo-on-libvirt-api/"/>
    <updated>2012-04-01T23:36:00+09:00</updated>
    <id>http://blog.branch4.pw/blog/2012/04/01/memo-on-libvirt-api</id>
    <content type="html"><![CDATA[<div  class=post>
  This is just a memo.  <br> <br>
  I will take a look at this article when I use libvirt API.  <br> <br>
  <a  href=http://www.atmarkit.co.jp/flinux/rensai/linuxkvm03/03b.html>http://www.atmarkit.co.jp/flinux/rensai/linuxkvm03/03b.html</a>
  <br> <br>
  I am sorry that it is all in Japanese.
</div>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Managing KVM Image With Virt-manager]]></title>
    <link href="http://blog.branch4.pw/blog/2012/03/12/managing-kvm-image-with-virt-manager/"/>
    <updated>2012-03-12T21:53:00+09:00</updated>
    <id>http://blog.branch4.pw/blog/2012/03/12/managing-kvm-image-with-virt-manager</id>
    <content type="html"><![CDATA[<div  class=post>
  # Some information added on 2012/4/1(at the end of an article) <br> <br>
  On my last post, I wrote about installation of Slackware on KVM.  <br> <br>
  I used kvm command.  <br> <br>
  Today, I'll write about managing KVM images.  <br> <br>
  It looks like virsh(Command line) or virt-manager(GUI) is popular.  <br> <br>
  First, about virt-manager.  <br> <br>
  1. install virt-manager <br>
  # apt-get install virt-manager <br> <br>
  2. boot virt-manager <br>
  I had a minor trouble where virt-manager complained about not being <br>
  able to connect to the local QEMU.  <br> <br>
  It told me to <br>
  - check if I had installed libvirtd <br>
  - check if the user was in the libvirtd group <br>
  - check if the libvirtd was started <br> <br>
  I checked, and the user wasn't in the libvirtd group, which I added with <br>
  # adduser <user> libvirtd <br> <br>
  rebooted the whole system <br>
  # reboot <br> <br>
  and fixed the matter.  <br> <br>
  3. set the correct storage directory to virt-manager <br>
  On default, virt-manager is set to look for <br> <br>
  /var/lib/libvirt/images <br> <br>
  for the virtualized images.  <br> <br>
  On my last post, I used
  <strike >
    virt-install
  </strike>
   kvm command, and placed the image to <br> <br>
  /usr/local/kvs_images <br> <br>
  so I had to change that first.  <br> <br>
  To do that, edit, <br> <br>
  /etc/libvirt/storage/default.xml <br> <br>
  change the following to <br> <br>
  before <br>
  <path>/var/lib/libvirt/images</path> <br> <br>
  after <br> <br>
  <path>/usr/local/kvs_images</path> <br>
  <br>
  and reboot libvirtd. <br>
  # service libvirt-bin restart<br>
  <div >
    and you'll be able to see the images you created with virt-install.  <br> <br>
    4. setup xml file for slackware guest <br>
    create a test file with kvm command in it.  <br>
    In my case this is it.  <br> <br>
    ---------------------test.txt--------------------- <br>
    kvm -drive file=/usr/local/kvm_images/slak01.img,if=virtio,boot=on -boot d -m 512 -monitor stdio <br> <br>
    -------------------------------------------------- <br> <br>
    Hit command below.  <br>
    # virsh domxml-from-native qemu-argv test.txt > test.xml
  </div>
  <div >
    <br>
    Edit some lines.  <br>
    Especially, <emulator> line as follows.  <br> <br> <br>
    <emulator>/usr/bin/qemu-system-x86_64</emulator> <br>
    <br>
    Execute, <br>
    # virsh <br>
    # define slak01 # in the virsh prompt <br> <br>
    And you'll now be able to use your slak from virt-manager!  <br> <br>
  </div>
  That's all for today.  <br>
  <div >
    Byebye.  <br> <br> <br>
    # added on 2012/4/2 <br> <br>
    When managing KVM image on virt-manager(on ubuntu), <br> <br>
    there is a configuration file on /etc/libvirt/qemu/*.xml.  <br> <br>
    It's called a Domain XML.  <br> <br>
    And the format is in the web site below.  <br> <br>
    <a  href=http://libvirt.org/formatdomain.html>http://libvirt.org/formatdomain.html</a>
    <br>
    <br>
  </div>
</div>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Slackware on KVM]]></title>
    <link href="http://blog.branch4.pw/blog/2012/03/11/slackware-on-kvm/"/>
    <updated>2012-03-11T02:07:00+09:00</updated>
    <id>http://blog.branch4.pw/blog/2012/03/11/slackware-on-kvm</id>
    <content type="html"><![CDATA[<p>こんにちは。KVM でSlackware動かしてみようかなー、と思った<a href="https://twitter.com/xengineer01">@xengineer01</a>です。</p>

<h2>概要</h2>

<p>特に目新しいことはなく、タイトル通りですわ。<br/>
まずは、Google様に、"slackware"と聞いてみて、<a href="http://www.slackware.com">本家サイト</a>へ。<br/>
で、どっかのミラーからslackware64のisoを拝借して、md5のcheckだけしとく。</p>

<p><code>
% md5sum -c slackware64-14.1-xxx.iso
% cat slackwar64-14.1-xxx.md5
</code></p>

<p>僕が15年くらい前にはじめてLinuxインストールしたのがSlackware3.2くらいの頃だったので、<br/>
majorバージョンでいうと11あがってるのか。でもなんか途中で、沢山バージョン飛ばしてた気が。</p>

<table>
<thead>
<tr>
<th align="center">Version </th>
<th align="center"> Releasedate     </th>
<th align="center"> End-of-life date </th>
<th align="center"> Kernel version</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">1.00    </td>
<td align="center"> 17 July 1993    </td>
<td align="center">         ??       </td>
<td align="center"> 0.99.11 Alpha</td>
</tr>
<tr>
<td align="center">1.1     </td>
<td align="center"> 5 November 1993 </td>
<td align="center">         ??       </td>
<td align="center"> 0.99.13</td>
</tr>
<tr>
<td align="center">2.0     </td>
<td align="center">   2 July 1994   </td>
<td align="center">          ??      </td>
<td align="center"> 1.0.9</td>
</tr>
<tr>
<td align="center">2.1     </td>
<td align="center"> 31 October 1994 </td>
<td align="center">  ??              </td>
<td align="center"> 1.1.59</td>
</tr>
<tr>
<td align="center">2.2     </td>
<td align="center"> 30 March 1995   </td>
<td align="center"> ??               </td>
<td align="center"> 1.2.1</td>
</tr>
<tr>
<td align="center">2.3     </td>
<td align="center"> 24 May 1995     </td>
<td align="center"> ??               </td>
<td align="center"> 1.2.8</td>
</tr>
<tr>
<td align="center">3.0     </td>
<td align="center">30 November 1995 </td>
<td align="center"> ??               </td>
<td align="center"> 1.2.13</td>
</tr>
<tr>
<td align="center">3.1     </td>
<td align="center">  3 June 1996    </td>
<td align="center"> ??               </td>
<td align="center"> 2.0.0</td>
</tr>
<tr>
<td align="center">3.2     </td>
<td align="center">17 February 1997 </td>
<td align="center"> ??               </td>
<td align="center"> 2.0.29</td>
</tr>
<tr>
<td align="center">3.3     </td>
<td align="center"> 11 June 1997    </td>
<td align="center"> ??               </td>
<td align="center"> 2.0.30</td>
</tr>
<tr>
<td align="center">3.4     </td>
<td align="center"> 14 October 1997 </td>
<td align="center"> ??               </td>
<td align="center"> 2.0.30</td>
</tr>
<tr>
<td align="center">3.5     </td>
<td align="center">  9 June 1998    </td>
<td align="center"> ??               </td>
<td align="center"> 2.0.34</td>
</tr>
<tr>
<td align="center">3.6     </td>
<td align="center"> 28 October 1998 </td>
<td align="center"> ??               </td>
<td align="center"> 2.0.35</td>
</tr>
<tr>
<td align="center">3.9     </td>
<td align="center"> 10 May 1999     </td>
<td align="center"> ??               </td>
<td align="center"> 2.0.37pre10</td>
</tr>
<tr>
<td align="center">4.0     </td>
<td align="center"> 17 May 1999     </td>
<td align="center"> ??               </td>
<td align="center"> 2.2.6</td>
</tr>
<tr>
<td align="center">7.0     </td>
<td align="center"> 25 October 1999 </td>
<td align="center"> ??               </td>
<td align="center"> 2.2.13</td>
</tr>
<tr>
<td align="center">7.1     </td>
<td align="center"> 22 June 2000    </td>
<td align="center"> ??               </td>
<td align="center"> 2.2.16</td>
</tr>
<tr>
<td align="center">8.0     </td>
<td align="center">  1 July 2001    </td>
<td align="center"> ??               </td>
<td align="center"> 2.2.19</td>
</tr>
<tr>
<td align="center">8.1     </td>
<td align="center"> 18 June 2002    </td>
<td align="center"> 1 August 2012    </td>
<td align="center"> 2.4.18</td>
</tr>
<tr>
<td align="center">9.0     </td>
<td align="center"> 19 March 2003   </td>
<td align="center"> 1 August 2012    </td>
<td align="center"> 2.4.20</td>
</tr>
<tr>
<td align="center">9.1     </td>
<td align="center">26 September 2003</td>
<td align="center"> 1 August 2012    </td>
<td align="center"> 2.4.22</td>
</tr>
<tr>
<td align="center">10.0    </td>
<td align="center"> 23 June 2004    </td>
<td align="center"> 1 August 2012    </td>
<td align="center"> 2.4.26</td>
</tr>
<tr>
<td align="center">10.1    </td>
<td align="center">  2 February 2005</td>
<td align="center"> 1 August 2012    </td>
<td align="center"> 2.4.29</td>
</tr>
<tr>
<td align="center">10.2    </td>
<td align="center">14 September 2005</td>
<td align="center"> 1 August 2012    </td>
<td align="center"> 2.4.31</td>
</tr>
<tr>
<td align="center">11.0    </td>
<td align="center">  2 October 2006 </td>
<td align="center">1 August 2012     </td>
<td align="center"> 2.4.33.3</td>
</tr>
<tr>
<td align="center">12.0    </td>
<td align="center">  1 July 2007    </td>
<td align="center">1 August 2012     </td>
<td align="center"> 2.6.21.5</td>
</tr>
<tr>
<td align="center">12.1    </td>
<td align="center">  2 May 2008     </td>
<td align="center">9 December 2013   </td>
<td align="center"> 2.6.24.5</td>
</tr>
<tr>
<td align="center">12.2    </td>
<td align="center">10 December 2008 </td>
<td align="center">9 December 2013   </td>
<td align="center"> 2.6.27.7</td>
</tr>
<tr>
<td align="center">13.0    </td>
<td align="center"> 26 August 2009  </td>
<td align="center"> ??               </td>
<td align="center"> 2.6.29.6</td>
</tr>
<tr>
<td align="center">13.1    </td>
<td align="center"> 24 May 2010     </td>
<td align="center"> ??               </td>
<td align="center"> 2.6.33.4</td>
</tr>
<tr>
<td align="center">13.37   </td>
<td align="center"> 27 April 2011   </td>
<td align="center"> ??               </td>
<td align="center"> 2.6.37.6</td>
</tr>
<tr>
<td align="center">14.0    </td>
<td align="center">28 September 2012</td>
<td align="center"> ??               </td>
<td align="center"> 3.2.29</td>
</tr>
<tr>
<td align="center">14.1    </td>
<td align="center"> 4 November 2013 </td>
<td align="center"> ??               </td>
<td align="center"> 3.10.17</td>
</tr>
</tbody>
</table>


<p>おお、4.0 &ndash;> 7.0で飛んでるね！この間、3.5と4.0は使った記憶があるけど、<br/>
あとはインストールすらしていない・・・</p>

<p>なにはともあれインストール。<br/>
<a href="http://www.linuxquestions.org/questions/slackware-14/slackware64-current-kvm-guest-boot-issue-871981/">ここ</a>を参考に。</p>

<p>1 CPUが仮想化支援対応してるかの確認をする<br/>
<code>
$ grep -E 'vmx|svm' /proc/cpuinfo  
</code></p>

<p>vmx : Intel VT support
svm : AMD-V support</p>

<p><a href="http://www.intel.co.jp/content/www/jp/ja/virtualization/virtualization-technology/hardware-assist-virtualization-technology.html">Intel VT by Intel</a>
<a href="http://ja.wikipedia.org/wiki/%E3%82%A4%E3%83%B3%E3%83%86%E3%83%AB_%E3%83%90%E3%83%BC%E3%83%81%E3%83%A3%E3%83%A9%E3%82%A4%E3%82%BC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%83%BB%E3%83%86%E3%82%AF%E3%83%8E%E3%83%AD%E3%82%B8%E3%83%BC">Intel VT wiki</a>
<a href="http://www.atmarkit.co.jp/fsys/kaisetsu/085intelvt/intelvt.html">Intel VT by @IT</a></p>

<p><a href="http://gihyo.jp/dev/serial/01/vm_work/0005">Intel VT &amp; AMD-V by gihyo</a></p>

<p><a href="http://www.amd.com/ja-jp/solutions/servers/virtualization">AMD-V by AMD</a>
<a href="http://itpro.nikkeibp.co.jp/article/COLUMN/20061013/250707/">AMD-V by It-pro</a></p>

<p>対応してないと、、、遅いっす。<br/>
CeleronとかAtomじゃなければ最近のCPUで対応してないものは少ないと思うけど。<br/>
そしてぐぐってみて思ったけど、AMD-Vのほうが情報が凄く少ない気がする・・・</p>

<p>VT技術サポートしなかったら、インストールできません！というわけじゃないけど、<br/>
すこぶる重いので、環境見直してからのほうがよいと思います。</p>

<p>2 install kvm and bridge-utils
```</p>

<h1>apt-get install kvm bridge-utils</h1>

<p><code>
3 Add user (that executes kvm) to group kvm
</code></p>

<h1>adduser <user> kvm</h1>

<p><code>
4 prepare images
</code>
$ kvm-img create -f qcow <somename>.img 10G<br/>
```
5 prepare guest OS images or CDs</p>

<p>I used ISO file.</p>

<p>```</p>

<h1>mount -t iso9660 -o loop <isofile> <mount point></h1>

<p><code>
6 execute kvm
</code>
$ kvm -drive file=/usr/local/kvm_images/slak01.img,if=virtio,boot=on -cdrom /usr/local/os_images/slackware64-13.37-install-dvd.iso -boot d -m 512 -monitor stdio<br/>
```
Then, you&rsquo;ll be seeing Slackware installer boot.<br/>
Now, never forget to use virtio.<br/>
You need this to install Slackware.</p>

<p>7 install Slackware
  You do this, Just as you install Slack on physical server,
  except that you&rsquo;ll fail to install LILO.<br/>
  * never choose btrfs as a filesystem for /boot, lilo don&rsquo;t like it<br/>
8 exit setup(we&rsquo;re gonna install LILO from here)<br/>
9 mount devices/sys/proc &ndash;> chroot
```</p>

<h1>mount -obind /dev /mnt/dev</h1>

<h1>mount -obind /sys /mnt/sys</h1>

<h1>mount -t proc proc /proc /mnt/proc chroot /mnt</h1>

<p>```
10 make initrd<br/>
  Edit mkinitrd.conf</p>

<p>```</p>

<h1>cd /etc/</h1>

<h1>cp mkinitrd.conf.sample mkinitrd.conf</h1>

<h1>vi mkinitrd.conf</h1>

<p>```
  Edit following lines:</p>

<p><code>
MODULE_LIST="ext4:virtio_blk:virtio_pci"
ROOTFS="ext4"
ROOTDEV="/dev/vda3"  
</code></p>

<p>  Get a command line for making initrd.</p>

<p>```</p>

<h1>/usr/share/mkinitrd/mkinitrd_command_generator.sh -r</h1>

<h1>&gt;execute above command&rsquo;s output here! &lt;</h1>

<p><code>
11. edit lilo.conf
</code></p>

<h1>vi /etc/lilo.conf</h1>

<p>```</p>

<p>  Add following line after boot = /dev/vda</p>

<p><code>
disk = /dev/vda bios=0x80 max-partitions=7  
</code>
  Add following line after image = /boot/vmlinuz
<code>
initrd = /boot/initrd.gz  
</code>
  Comment out root = /dev/vda3.</p>

<ol>
<li>install LILO
```

<h1>lilo</h1>

<p>```</p></li>
<li>reboot
```

<h1>reboot</h1>

<p>```</p></li>
<li>pray it to boot up</li>
</ol>


<p>That&rsquo;s all for today.<br/>
That did it for me, I think.</p>
]]></content>
  </entry>
  
</feed>
