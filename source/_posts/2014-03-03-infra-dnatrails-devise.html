---
layout: post
title: "[infra] DNAT環境下でのrails + devise "
date: 2014-03-03T09:19:00-08:00
comments: true
categories:
 - Infra
 - Ruby on Rails
---
<div  class=post>
  railsとdeviseを組み合わせて使うことはよくあることです。たぶん。 <br>
  んで、DNAT環境下で使うと、最初に認証できなかったら、認証画面に <br>
  リダイレクトする、っていうとこで困っちゃう。というか僕は困っちゃった。 <br> <br>
  deviseのサイトに、認証失敗時のリダイレクトを任意画面にする、的な方法が <br>
  出てたけど、そこだけが対応箇所なのかもようわからんので、nginx側で、 <br>
  30x系リダイレクト時の、Locationヘッダを書き換える方法にしてみた話。 <br>
  いえ、全然難しくないんだけどね。。。 <br>
  <!-- more -->
  <br>
  nginx.confあたりに、 <br> <br>
  <pre  class=prettyprint>
    <span  style=font-size: small;>
      proxy_redirect http://xxx.yyy.jp/ http://xxx.yyy.jp:10080/;
    </span></pre>
  って書く。するとHTTP responseで、 <br><br>
  Location: http://xxx.yyy.jp/ <br> <br>
  を受信したときに、 <br> <br>
  Location: http://xxx.yyy.jp:10080/ <br> <br>
  に書き換えてくれますよ、って話。 <br>
  今度わかりやすいように図解もつけようかな。 <br>
  今日は眠いからこれで終了。 <br>
</div>
